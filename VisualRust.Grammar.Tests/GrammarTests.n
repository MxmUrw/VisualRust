using Nemerle.Collections;
using Nemerle.Text;
using Nemerle.Utility;

using System;
using System.Collections.Generic;
using System.Linq;
using System.IO;
using System.Web;

using Microsoft.VisualStudio.TestTools.UnitTesting;

using VisualRust.Grammar;
using Nitra.ProjectSystem;

using System.Threading;

namespace VisualRust.Grammar.Tests
{
    [TestClass]  
    public class GrammarTests
    {   
        public TestContext : TestContext { get; set; }
  
        [TestMethod]
        [RustTestDirectory("../../../rust/src/test/run-make", "run-make.xml")]
        [DataSource("Microsoft.VisualStudio.TestTools.DataSource.XML", "run-make.xml", "Filename", DataAccessMethod.Sequential)]
        public RunMake() : void
        {
            PositiveTest()
        }
        
        [TestMethod]
        [RustTestDirectory("../../../rust/src/test/run-pass", "run-pass.xml")]
        [DataSource("Microsoft.VisualStudio.TestTools.DataSource.XML", "run-pass.xml", "Filename", DataAccessMethod.Sequential)]
        public RunPass() : void
        {
            PositiveTest()
        }
        
        [TestMethod]
        [RustTestDirectory("../../../rust/src/test/run-pass-fulldeps", "run-pass-fulldeps.xml")]
        [DataSource("Microsoft.VisualStudio.TestTools.DataSource.XML", "run-pass-fulldeps.xml", "Filename", DataAccessMethod.Sequential)]
        public RunPassFulldeps() : void
        {
            PositiveTest()
        }
        
        [TestMethod]
        [RustTestDirectory("../../examples", "examples.xml")]
        [DataSource("Microsoft.VisualStudio.TestTools.DataSource.XML", "examples.xml", "Filename", DataAccessMethod.Sequential)]
        public RunExamples() : void
        {
            PositiveTest()
        }
  
        [TestMethod]
        [RustTestDirectory("../../../rust/src", "run-rust-lang.xml", "../../../rust/src/test")]
        [DataSource("Microsoft.VisualStudio.TestTools.DataSource.XML", "run-rust-lang.xml", "Filename", DataAccessMethod.Sequential)]
        public RunRustLang() : void
        {
            mutable exception = None();
            
            def t = Thread(() => exception = SafeRun(PositiveTest), 32 * 1024 * 1024);
            t.Start();
            t.Join();
            
            exception.Iter(x => throw x);
        }
        
        private SafeRun(action : Action) : option[Exception]
        {
            try
            {
                action();
                None()
            }
            catch
            {
                e is Exception => Some(e)
            }
        }

        private PositiveTest() : void
        {
            def filename = TestContext.DataRow[0] :> string;
            def file = FsFile(filename, NitraRust.Instance);
                 
            Assert.IsTrue(
                file.ParseResult.IsSuccess, Uri(Path.GetFullPath(filename)).AbsoluteUri + "\n" + $<#..$(file.GetCompilerMessages();"\n")#>);
        }
    }
}
